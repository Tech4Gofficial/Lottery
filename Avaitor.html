<!DOCTYPE html>
<html>
<head>
  <title>Aviator</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
  <h2>‚úàÔ∏è Aviator</h2>

  <div class="balance">
    Balance ‚Çπ<span id="bal">0</span>
  </div>

  <input type="number" id="bet" value="100" placeholder="Bet Amount">

  <div>
    <input type="checkbox" id="autoToggle"> Auto Cashout
  </div>

  <input type="number" id="autoValue" step="0.01" placeholder="Auto x (eg 1.50)">

  <div>
    <button id="startBtn" onclick="startGame()">BET</button>
    <button id="cashoutBtn" onclick="manualCashout()" disabled>CASHOUT</button>
  </div>

  <div id="multi">1.00x</div>
  <div id="msg"></div>

  <div id="round">Next round in <span id="count">5</span>s</div>

  <a href="games.html">‚¨Ö Back</a>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let uid;
let balance = 0;
let betAmt = 0;
let multiplier = 1;
let timer = null;
let playing = false;
let crashed = false;
let cashedOut = false;
let adminCrashAt = 999;
let roundCountdown = 5;
let speed = 0.01; // slower speed (IMPORTANT FIX)

// ---------- AUTH ----------
firebase.auth().onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  uid = user.uid;

  firebase.database().ref("users/"+uid+"/balance")
    .on("value", s => {
      balance = s.val() || 0;
      bal.innerText = balance;
    });

  firebase.database().ref("admin/crashAt")
    .on("value", s => {
      if(s.exists()) adminCrashAt = Number(s.val());
    });
});

// ---------- ROUND COUNTDOWN ----------
function startCountdown(){
  count.innerText = roundCountdown;
  const cd = setInterval(()=>{
    roundCountdown--;
    count.innerText = roundCountdown;
    if(roundCountdown === 0){
      clearInterval(cd);
      roundCountdown = 5;
      startBtn.disabled = false;
    }
  },1000);
}

// ---------- START GAME ----------
function startGame(){
  betAmt = Number(bet.value);
  if(betAmt <= 0 || betAmt > balance) return alert("Invalid bet");

  startBtn.disabled = true;
  cashoutBtn.disabled = false;

  playing = true;
  crashed = false;
  cashedOut = false;
  multiplier = 1;
  multi.innerText = "1.00x";
  msg.innerText = "Flying...";

  timer = setInterval(gameLoop, 100);
}

// ---------- GAME LOOP ----------
function gameLoop(){
  multiplier += speed;
  multi.innerText = multiplier.toFixed(2) + "x";

  // ADMIN CRASH (TOP PRIORITY)
  if(multiplier >= adminCrashAt){
    crash();
    return;
  }

  // AUTO CASHOUT
  if(
    !cashedOut &&
    autoToggle.checked &&
    Number(autoValue.value) > 1 &&
    multiplier >= Number(autoValue.value)
  ){
    cashout(false);
  }
}

// ---------- CASHOUT ----------
function manualCashout(){
  if(!playing || cashedOut) return;
  cashout(true);
}

function cashout(manual){
  cashedOut = true;
  let profit = Math.floor(betAmt * (multiplier - 1));
  updateBalance(profit);
  msg.innerText = manual ? "‚úÖ Manual Cashout" : "‚úÖ Auto Cashout";
  endGame();
}

// ---------- CRASH ----------
function crash(){
  crashed = true;
  multi.classList.add("crash");
  msg.innerText = "üí• CRASHED!";
  if(!cashedOut){
    updateBalance(-betAmt);
  }
  endGame();
}

// ---------- END ----------
function endGame(){
  clearInterval(timer);
  playing = false;
  cashoutBtn.disabled = true;
  multi.classList.remove("crash");
  startCountdown();
}

// ---------- BALANCE ----------
function updateBalance(amount){
  firebase.database().ref("users/"+uid+"/balance")
    .set(balance + amount);
}
</script>
</body>
</html>
