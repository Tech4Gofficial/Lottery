<!DOCTYPE html>
<html>
<head>
<title>Aviator</title>
<link rel="stylesheet" href="style.css">
<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card{
  background:#020617;
  padding:20px;
  border-radius:12px;
  width:320px;
  text-align:center;
  box-shadow:0 0 20px rgba(0,255,255,.2);
}
#curve{
  height:120px;
  background:linear-gradient(135deg,#22c55e,#0ea5e9);
  border-radius:8px;
  margin:10px 0;
  position:relative;
  overflow:hidden;
}
#plane{
  position:absolute;
  bottom:10px;
  left:10px;
  font-size:24px;
  transition:transform .1s linear;
}
#multi{
  font-size:28px;
  margin:10px 0;
}
.crash{
  color:red;
  animation:shake .3s infinite;
}
@keyframes shake{
  0%{transform:translateX(0)}
  25%{transform:translateX(2px)}
  50%{transform:translateX(-2px)}
}
input,button{
  width:90%;
  padding:8px;
  margin:6px 0;
  border-radius:6px;
  border:none;
}
button{
  background:#22c55e;
  color:black;
  font-weight:bold;
  cursor:pointer;
}
button:hover{opacity:.85}
</style>
</head>

<body>
<div class="card">
<h2>‚úàÔ∏è Aviator</h2>
<p>Balance ‚Çπ<span id="bal">0</span></p>

<input type="number" id="bet" placeholder="Bet Amount" value="10">
<input type="number" id="auto" placeholder="Auto Cashout (eg 1.50)" step="0.01">

<button onclick="start()">Start</button>
<button onclick="cashout()">Cashout</button>

<div id="curve">
  <div id="plane">‚úàÔ∏è</div>
</div>

<div id="multi">1.00x</div>
<p id="msg"></p>

<a href="games.html">‚¨Ö Back</a><br><br>
<button onclick="logout()">Logout</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let uid;
let multiplier = 1;
let betAmt = 0;
let interval;
let crashed = false;
let playing = false;
let playingAuto = false;
let adminCrashAt = 999;

// Auth & balance
firebase.auth().onAuthStateChanged(user => {
  if(!user){ location.href="index.html"; return; }
  uid = user.uid;

  // Balance listener
  firebase.database().ref("users/"+uid+"/balance")
    .on("value", s => bal.innerText = s.val() || 0);

  // Admin crash listener
  firebase.database().ref("admin/crashAt")
    .on("value", s => {
      if(s.exists()) adminCrashAt = parseFloat(s.val());
      console.log("Admin crashAt:", adminCrashAt);
    });
});

// Start game
function start(){
  if(playing) return alert("Game running");
  betAmt = Number(bet.value);
  if(betAmt <= 0) return alert("Invalid bet");

  playing = true;
  crashed = false;
  playingAuto = false;
  multiplier = 1;
  multi.innerText = "1.00x";
  msg.innerText = "Flying...";
  plane.style.transform = "translate(0,0)";
  multi.classList.remove("crash");

  interval = setInterval(() => {
    multiplier += 0.02;
    multi.innerText = multiplier.toFixed(2) + "x";
    plane.style.transform = `translate(${multiplier*15}px,${-multiplier*6}px)`;

    // 1Ô∏è‚É£ Admin crash (highest priority)
    if(!crashed && multiplier >= adminCrashAt){
      crash();
      return;
    }

    // 2Ô∏è‚É£ Auto cashout (only below admin crash)
    let auto = Number(document.getElementById("auto").value);
    if(!crashed && !playingAuto && auto > 1 && auto < adminCrashAt && multiplier >= auto){
      playingAuto = true;
      cashout();
    }

  }, 100);
}

// Cashout
function cashout(){
  if(!playing || crashed) return;
  let win = Math.floor(betAmt * multiplier);
  updateBalance(win);
  msg.innerText = "‚úÖ Cashed out ‚Çπ" + win;
  endGame();
}

// Crash
function crash(){
  if(crashed) return;
  crashed = true;
  multi.classList.add("crash");
  msg.innerText = "üí• CRASHED!";
  updateBalance(-betAmt);
  endGame();
}

// End game
function endGame(){
  clearInterval(interval);
  playing = false;
}

// Update Firebase balance
function updateBalance(amount){
  const ref = firebase.database().ref("users/"+uid+"/balance");
  ref.once("value").then(s => {
    ref.set((s.val()||0) + amount);
  });
}

// Logout
function logout(){
  firebase.auth().signOut();
  location.href="index.html";
}
</script>
</body>
</html>
