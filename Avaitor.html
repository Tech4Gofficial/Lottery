<!DOCTYPE html>
<html>
<head>
<title>Aviator</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
<h2>‚úàÔ∏è Aviator</h2>

<p>Balance ‚Çπ<span id="bal">0</span></p>
<p>Round: <span id="roundId">1</span></p>
<p>Countdown: <span id="countdown">10</span>s</p>

<input type="number" id="bet" value="10" placeholder="Bet Amount">

<div>
  <input type="checkbox" id="autoToggle"><label>Auto Cashout</label>
  <input type="number" id="autoValue" step="0.01" placeholder="Auto Cashout x">
</div>

<button onclick="manualCashout()">Cashout</button>

<div id="curve">
  <div id="plane">‚úàÔ∏è</div>
</div>

<div id="multi">1.00x</div>
<p id="msg"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let uid;
let betAmt = 0;
let multiplier = 1;
let interval = null;
let playing = false;
let crashed = false;
let cashedOut = false;

// Admin controls
let adminCrashAt = 999;
let roundId = 1;
let localCountdown = 10;
let status = "waiting"; // waiting = countdown, flying = plane moving

// ===== AUTH & BALANCE =====
firebase.auth().onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  uid = user.uid;

  firebase.database().ref("users/"+uid+"/balance")
    .on("value", snap => document.getElementById("bal").innerText = snap.val() || 0);

  // Read admin info once
  firebase.database().ref("admin").once("value").then(snap=>{
    if(snap.exists()){
      const data = snap.val();
      localCountdown = data.countdown || 10;
      roundId = data.roundId || 1;
      status = data.status || "waiting";
      adminCrashAt = parseFloat(data.crashAt || 999);

      document.getElementById("countdown").innerText = localCountdown;
      document.getElementById("roundId").innerText = roundId;
    }
  });

  // Listen admin crash multiplier changes
  firebase.database().ref("admin/crashAt").on("value", snap=>{
    if(snap.exists()) adminCrashAt = parseFloat(snap.val());
  });
});

// ===== COUNTDOWN TIMER =====
setInterval(()=>{
  if(status === "waiting"){
    localCountdown--;
    if(localCountdown <= 0){
      localCountdown = 0;
      document.getElementById("countdown").innerText = 0;
      startRound();
    } else {
      document.getElementById("countdown").innerText = localCountdown;
    }
    // Sync to Firebase
    firebase.database().ref("admin/countdown").set(localCountdown);
  }
},1000);

// ===== START ROUND =====
function startRound(){
  if(playing) return;
  status = "flying";
  firebase.database().ref("admin").update({status:"flying"});
  startGame();
}

// ===== START GAME =====
function startGame(){
  playing = true;
  crashed = false;
  cashedOut = false;
  multiplier = 1;

  document.getElementById("multi").innerText = "1.00x";
  document.getElementById("msg").innerText = "Flying...";
  document.getElementById("plane").style.transform="translate(0,0)";

  interval = setInterval(gameLoop, 150);
}

// ===== GAME LOOP =====
function gameLoop(){
  multiplier += 0.01;
  document.getElementById("multi").innerText = multiplier.toFixed(2)+"x";
  document.getElementById("plane").style.transform = `translate(${multiplier*15}px,${-multiplier*6}px)`;

  // Admin crash
  if(!crashed && multiplier >= adminCrashAt){
    crash();
    return;
  }

  // Auto cashout
  const autoEnabled = document.getElementById("autoToggle").checked;
  const autoValue = Number(document.getElementById("autoValue").value);
  if(autoEnabled && !cashedOut && autoValue>1 && multiplier>=autoValue && multiplier<adminCrashAt){
    doCashout("Auto");
  }
}

// ===== CASHOUT =====
function doCashout(type){
  cashedOut = true;
  const profit = Math.floor(betAmt * (multiplier-1)); // profit only
  updateBalance(profit);
  document.getElementById("msg").innerText = `‚úÖ ${type} Cashout +‚Çπ${profit}`;
}

// ===== MANUAL CASHOUT =====
function manualCashout(){
  if(!playing || cashedOut) return;
  doCashout("Manual");
}

// ===== CRASH =====
function crash(){
  crashed = true;
  document.getElementById("multi").classList.add("crash");
  document.getElementById("msg").innerText="üí• CRASHED!";
  if(!cashedOut) updateBalance(-betAmt);
  endGame();

  // Reset countdown and next round
  localCountdown = 10;
  roundId++;
  status = "waiting";
  firebase.database().ref("admin").update({
    roundId: roundId,
    countdown: localCountdown,
    status: status
  });
  document.getElementById("roundId").innerText = roundId;
}

// ===== END GAME =====
function endGame(){
  clearInterval(interval);
  playing = false;
}

// ===== UPDATE BALANCE =====
function updateBalance(amount){
  const ref = firebase.database().ref("users/"+uid+"/balance");
  ref.once("value").then(snap => ref.set((snap.val()||0)+amount));
}
</script>
</body>
</html>
