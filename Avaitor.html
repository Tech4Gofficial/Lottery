<!DOCTYPE html>
<html>
<head>
<title>Aviator</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="card">
  <h2>‚úàÔ∏è Aviator</h2>

  <p>Balance ‚Çπ<span id="bal">0</span></p>

  <input type="number" id="bet" value="10" placeholder="Bet Amount">

  <label>
    <input type="checkbox" id="autoToggle">
    Auto Cashout
  </label>

  <input type="number" id="autoValue" step="0.01" placeholder="Auto x (eg 1.50)">

  <button id="startBtn" onclick="start()">Start</button>
  <button id="cashoutBtn" onclick="manualCashout()" disabled>Cashout</button>

  <div id="curve">
    <div id="plane">‚úàÔ∏è</div>
  </div>

  <div id="multi">1.00x</div>
  <p id="msg"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
/* ===== GLOBAL STATE ===== */
let uid;
let balance = 0;
let betAmt = 0;
let multiplier = 1;
let interval = null;
let playing = false;
let crashed = false;
let cashedOut = false;
let adminCrashAt = 999;

/* ===== AUTH & FIREBASE ===== */
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  uid = user.uid;

  firebase.database().ref("users/" + uid + "/balance")
    .on("value", s => {
      balance = Number(s.val()) || 0;
      bal.innerText = balance;
    });

  firebase.database().ref("admin/crashAt")
    .on("value", s => {
      if (s.exists()) {
        adminCrashAt = parseFloat(s.val());
        console.log("ADMIN CRASH AT:", adminCrashAt);
      }
    });
});

/* ===== START GAME ===== */
function start() {
  if (playing) return;

  betAmt = Number(bet.value);
  if (betAmt <= 0) return alert("Invalid bet");
  if (betAmt > balance) return alert("Insufficient balance");

  /* Deduct bet first */
  updateBalance(-betAmt);

  playing = true;
  crashed = false;
  cashedOut = false;
  multiplier = 1;

  startBtn.disabled = true;
  cashoutBtn.disabled = false;

  msg.innerText = "Flying...";
  multi.innerText = "1.00x";
  plane.style.transform = "translate(0,0)";
  multi.classList.remove("crash");

  interval = setInterval(gameLoop, 100);
}

/* ===== MAIN GAME LOOP ===== */
function gameLoop() {
  multiplier += 0.02;
  multi.innerText = multiplier.toFixed(2) + "x";

  plane.style.transform =
    `translate(${multiplier * 15}px, ${-multiplier * 6}px)`;

  /* üî• ADMIN CRASH ‚Äî FIRST PRIORITY */
  if (!crashed && multiplier >= adminCrashAt) {
    crash();
    return;
  }

  /* üí∞ AUTO CASHOUT */
  if (
    !cashedOut &&
    autoToggle.checked &&
    Number(autoValue.value) > 1 &&
    multiplier >= Number(autoValue.value)
  ) {
    doCashout("Auto");
  }
}

/* ===== CASHOUT LOGIC ===== */
function doCashout(type) {
  if (cashedOut) return;

  cashedOut = true;

  /* PROFIT ONLY */
  let profit = Math.floor(betAmt * (multiplier - 1));
  updateBalance(betAmt + profit);

  msg.innerText = `‚úÖ ${type} Cashout +‚Çπ${profit}`;
}

/* ===== MANUAL CASHOUT ===== */
function manualCashout() {
  if (!playing || cashedOut) return;
  doCashout("Manual");
  endGame();
}

/* ===== CRASH ===== */
function crash() {
  crashed = true;
  multi.classList.add("crash");
  msg.innerText = "üí• CRASHED!";
  endGame();
}

/* ===== END GAME ===== */
function endGame() {
  clearInterval(interval);
  playing = false;
  startBtn.disabled = false;
  cashoutBtn.disabled = true;
}

/* ===== UPDATE BALANCE ===== */
function updateBalance(amount) {
  const ref = firebase.database().ref("users/" + uid + "/balance");
  ref.once("value").then(s => {
    ref.set((Number(s.val()) || 0) + amount);
  });
}
</script>

</body>
</html>
