<!DOCTYPE html>
<html>
<head>
<title>Aviator</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
<h2>‚úàÔ∏è Aviator</h2>

<p>Balance ‚Çπ<span id="bal">0</span></p>
<p>Round: <span id="roundId">1</span></p>
<p>Countdown: <span id="countdown">0</span>s</p>

<input type="number" id="bet" value="10" placeholder="Bet Amount">
<div>
  <input type="checkbox" id="autoToggle"><label>Auto Cashout</label>
  <input type="number" id="autoValue" step="0.01" placeholder="Auto Cashout x">
</div>

<button onclick="startGame()">Start</button>
<button onclick="manualCashout()">Cashout</button>

<div id="curve">
  <div id="plane">‚úàÔ∏è</div>
</div>

<div id="multi">1.00x</div>
<p id="msg"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let uid;
let balance = 0;
let betAmt = 0;
let multiplier = 1;
let interval = null;
let playing = false;
let crashed = false;
let cashedOut = false;

let adminCrashAt = 999;
let roundId = 1;
let countdown = 0;

/* ===== AUTH & BALANCE ===== */
firebase.auth().onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  uid=user.uid;

  firebase.database().ref("users/"+uid+"/balance")
    .on("value", s=>bal.innerText = s.val() ?? 0);

  // Read admin data
  firebase.database().ref("admin").on("value", snap=>{
    if(snap.exists()){
      const data = snap.val();
      adminCrashAt = parseFloat(data.crashAt || 999);
      roundId = data.roundId || 1;
      countdown = data.countdown || 10;
      document.getElementById("roundId").innerText = roundId;
      document.getElementById("countdown").innerText = countdown;
    }
  });
});

/* ===== COUNTDOWN TIMER ===== */
setInterval(()=>{
  if(countdown > 0){
    countdown -= 1;
    document.getElementById("countdown").innerText = countdown;
    firebase.database().ref("admin/countdown").set(countdown);
  } else if(!playing){
    // Start new round automatically
    firebase.database().ref("admin/status").set("flying");
    startGame();
  }
}, 1000);

/* ===== START GAME ===== */
function startGame(){
  if(playing) return;

  betAmt = Number(document.getElementById("bet").value);
  if(betAmt <= 0) return alert("Invalid bet");

  playing = true;
  crashed = false;
  cashedOut = false;
  multiplier = 1;
  document.getElementById("multi").innerText = "1.00x";
  document.getElementById("msg").innerText = "Flying...";
  document.getElementById("plane").style.transform="translate(0,0)";

  interval = setInterval(gameLoop, 150); // slower plane
}

/* ===== GAME LOOP ===== */
function gameLoop(){
  multiplier += 0.01; // slower speed
  document.getElementById("multi").innerText = multiplier.toFixed(2)+"x";
  document.getElementById("plane").style.transform=
    `translate(${multiplier*15}px,${-multiplier*6}px)`;

  // ADMIN CRASH
  if(!crashed && multiplier >= adminCrashAt){
    crash();
    return;
  }

  // AUTO CASHOUT
  let autoEnabled = document.getElementById("autoToggle").checked;
  let autoValue = Number(document.getElementById("autoValue").value);
  if(autoEnabled && !cashedOut && autoValue>1 && multiplier>=autoValue && multiplier<adminCrashAt){
    doCashout("Auto");
  }
}

/* ===== CASHOUT ===== */
function doCashout(type){
  cashedOut = true;
  let profit = Math.floor(betAmt * (multiplier-1)); // only profit
  updateBalance(profit);
  document.getElementById("msg").innerText = `‚úÖ ${type} Cashout +‚Çπ${profit}`;
}

/* ===== MANUAL CASHOUT ===== */
function manualCashout(){
  if(!playing || cashedOut) return;
  doCashout("Manual");
  endGame();
}

/* ===== CRASH ===== */
function crash(){
  crashed = true;
  document.getElementById("multi").classList.add("crash");
  document.getElementById("msg").innerText="üí• CRASHED!";
  if(!cashedOut){
    updateBalance(-betAmt);
  }
  endGame();
  // Increment round
  firebase.database().ref("admin").update({
    roundId: roundId+1,
    status: "waiting",
    countdown: 10
  });
}

/* ===== END GAME ===== */
function endGame(){
  clearInterval(interval);
  playing = false;
}

/* ===== UPDATE BALANCE ===== */
function updateBalance(amount){
  const ref = firebase.database().ref("users/"+uid+"/balance");
  ref.once("value").then(s=>{
    ref.set((s.val()||0)+amount);
  });
}
</script>
</body>
</html>
