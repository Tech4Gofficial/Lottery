<!DOCTYPE html>
<html>
<head>
<title>Aviator</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
<h2>âœˆï¸ Aviator</h2>

<p>Balance â‚¹<span id="bal">0</span></p>
<p>Round: <span id="roundId">1</span></p>
<p>Countdown: <span id="countdown">0</span>s</p>

<input type="number" id="bet" value="10" placeholder="Bet Amount">

<div>
  <input type="checkbox" id="autoToggle"><label>Auto Cashout</label>
  <input type="number" id="autoValue" step="0.01" placeholder="Auto Cashout x">
</div>

<button onclick="manualCashout()">Cashout</button>

<div id="curve">
  <div id="plane">âœˆï¸</div>
</div>

<div id="multi">1.00x</div>
<p id="msg"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
let uid;
let betAmt = 0;
let multiplier = 1;
let interval = null;
let playing = false;
let crashed = false;
let cashedOut = false;

// Admin control
let adminCrashAt = 999;
let roundId = 1;
let countdown = 10;

// ===== AUTH & BALANCE =====
firebase.auth().onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  uid = user.uid;

  // Listen user balance
  firebase.database().ref("users/"+uid+"/balance")
    .on("value", snap=>{
      document.getElementById("bal").innerText = snap.val() || 0;
    });

  // Read admin info once
  firebase.database().ref("admin").once("value").then(snap=>{
    if(snap.exists()){
      const data = snap.val();
      countdown = data.countdown || 10;
      roundId = data.roundId || 1;
      adminCrashAt = parseFloat(data.crashAt || 999);
      document.getElementById("countdown").innerText = countdown;
      document.getElementById("roundId").innerText = roundId;
    }
  });

  // Listen admin changes (crash multiplier)
  firebase.database().ref("admin/crashAt").on("value", snap=>{
    if(snap.exists()) adminCrashAt = parseFloat(snap.val());
  });
});

// ===== COUNTDOWN TIMER =====
setInterval(()=>{
  firebase.database().ref("admin/status").once("value").then(snap=>{
    const status = snap.val() || "waiting";

    // Decrement countdown only if waiting
    if(status === "waiting"){
      countdown--;
      if(countdown <= 0){
        countdown = 0;
        document.getElementById("countdown").innerText = countdown;
        // Start new round
        firebase.database().ref("admin").update({status:"flying"});
        startGame();
      } else {
        document.getElementById("countdown").innerText = countdown;
      }
      // Sync countdown to Firebase
      firebase.database().ref("admin/countdown").set(countdown);
    }
  });
}, 1000);

// ===== START GAME =====
function startGame(){
  if(playing) return;

  betAmt = Number(document.getElementById("bet").value);
  if(betAmt <= 0) return alert("Invalid bet");

  playing = true;
  crashed = false;
  cashedOut = false;
  multiplier = 1;

  document.getElementById("multi").innerText = "1.00x";
  document.getElementById("msg").innerText = "Flying...";
  document.getElementById("plane").style.transform="translate(0,0)";

  interval = setInterval(gameLoop, 150); // slower plane for precision
}

// ===== GAME LOOP =====
function gameLoop(){
  multiplier += 0.01;
  document.getElementById("multi").innerText = multiplier.toFixed(2)+"x";
  document.getElementById("plane").style.transform=
    `translate(${multiplier*15}px,${-multiplier*6}px)`;

  // ADMIN CRASH
  if(!crashed && multiplier >= adminCrashAt){
    crash();
    return;
  }

  // AUTO CASHOUT
  const autoEnabled = document.getElementById("autoToggle").checked;
  const autoValue = Number(document.getElementById("autoValue").value);
  if(autoEnabled && !cashedOut && autoValue>1 && multiplier>=autoValue && multiplier<adminCrashAt){
    doCashout("Auto");
  }
}

// ===== CASHOUT =====
function doCashout(type){
  cashedOut = true;
  const profit = Math.floor(betAmt * (multiplier-1)); // only profit
  updateBalance(profit);
  document.getElementById("msg").innerText = `âœ… ${type} Cashout +â‚¹${profit}`;
}

// ===== MANUAL CASHOUT =====
function manualCashout(){
  if(!playing || cashedOut) return;
  doCashout("Manual");
  endGame();
}

// ===== CRASH =====
function crash(){
  crashed = true;
  document.getElementById("multi").classList.add("crash");
  document.getElementById("msg").innerText="ğŸ’¥ CRASHED!";
  if(!cashedOut) updateBalance(-betAmt);
  endGame();

  // Increment round and reset countdown
  firebase.database().ref("admin").update({
    roundId: roundId+1,
    status:"waiting",
    countdown:10
  });
}

// ===== END GAME =====
function endGame(){
  clearInterval(interval);
  playing = false;
}

// ===== UPDATE BALANCE =====
function updateBalance(amount){
  const ref = firebase.database().ref("users/"+uid+"/balance");
  ref.once("value").then(s=>ref.set((s.val()||0)+amount));
}
</script>
</body>
</html>
