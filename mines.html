<!DOCTYPE html>
<html>
<head>
<title>Mines</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
<h2>ðŸ’£ Mines</h2>
<p>Balance: â‚¹<span id="bal">0</span></p>

<input type="number" id="bet" placeholder="Bet Amount" value="10"><br>
<button onclick="start()">Start</button>
<div id="grid"></div>
<p id="msg"></p>
<button onclick="cashout()">Cashout</button>
<a href="games.html">â¬… Back to Games</a><br><br>
<button onclick="logout()">Logout</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>
<script>
let uid, mine, opened=0, win=0, betAmt=10, gameActive=false;

firebase.auth().onAuthStateChanged(user=>{
  if(!user){location.href="index.html"; return;}
  uid=user.uid;
  const userRef=firebase.database().ref("users/"+uid);

  // initialize balance if missing
  userRef.child("balance").once("value").then(snap=>{
    if(!snap.exists()) userRef.set({balance:1020});
  });

  userRef.child("balance").on("value", snap => bal.innerText = snap.val() !== null ? Number(snap.val()) : 0);
});

function start(){
  if(gameActive) return alert("Finish current game!");
  betAmt=Number(bet.value);
  if(betAmt<=0) return alert("Enter a valid bet");
  gameActive=true;
  mine=Math.floor(Math.random()*5);
  opened=0;
  win=betAmt;
  grid.innerHTML="";
  msg.innerText="Pick a tile";

  for(let i=0;i<5;i++){
    let b=document.createElement("button");
    b.innerText="â“";
    b.onclick=()=>openTile(i,b);
    grid.appendChild(b);
  }
}

function openTile(i,btn){
  if(!gameActive) return;
  if(i===mine){
    btn.innerText="ðŸ’¥"; btn.classList.add("bomb");
    msg.innerText="Mine hit! Lost â‚¹"+betAmt;
    update(-betAmt);
    gameActive=false;
    grid.innerHTML="";
  } else {
    btn.innerText="ðŸ’Ž"; btn.classList.add("safe"); btn.disabled=true;
    opened++;
    win=Math.floor(betAmt*(1+opened*0.5));
    msg.innerText="Safe! Potential cashout â‚¹"+win;
  }
}

function cashout(){
  if(!gameActive || opened===0) return alert("No tiles opened");
  update(win);
  msg.innerText="Cashed out â‚¹"+win;
  gameActive=false;
  grid.innerHTML="";
}

function update(amount){
  firebase.database().ref("users/"+uid+"/balance").once("value").then(snap=>{
    firebase.database().ref("users/"+uid+"/balance").set(Number(snap.val())+amount);
  });
}

function logout(){
  firebase.auth().signOut();
  location.href="index.html";
}
</script>
</body>
</html>
