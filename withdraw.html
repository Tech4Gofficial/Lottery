<!DOCTYPE html>
<html>
<head>
  <title>Withdraw</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
  <h2>üí∏ Withdraw</h2>

  <p class="balance">
    Balance ‚Çπ<span id="bal">0</span>
  </p>

  <input id="upi" placeholder="Enter UPI ID"><br>
  <input id="amount" type="number" placeholder="Withdraw Amount"><br>

  <button onclick="submitWithdraw()">Withdraw</button>

  <p id="msg"></p>

  <a href="games.html">‚¨Ö Back</a>
</div>

<!-- Firebase -->
<script src="firebase.js"></script>

<script>
let uid = null;

/* ------------------------------
   AUTH & LOAD USER DATA
--------------------------------*/
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    alert("Please login first");
    location.href = "index.html";
    return;
  }

  uid = user.uid;

  // Listen to user data (balance + upi)
  firebase.database().ref("users/" + uid).on("value", snapshot => {
    const data = snapshot.val();

    if (!data) {
      bal.innerText = 0;
      return;
    }

    // Show balance
    bal.innerText = data.balance ?? 0;

    // Lock UPI if already saved
    if (data.upi) {
      upi.value = data.upi;
      upi.disabled = true;
    }
  });
});

/* ------------------------------
   SUBMIT WITHDRAW REQUEST
--------------------------------*/
function submitWithdraw() {
  const withdrawAmt = Number(amount.value);
  const upiId = upi.value.trim();

  msg.innerText = "";

  // Validation
  if (!upiId || !upiId.includes("@")) {
    msg.innerText = "‚ùå Enter a valid UPI ID";
    return;
  }

  if (withdrawAmt < 110 || withdrawAmt > 5000) {
    msg.innerText = "‚ùå Withdraw amount must be ‚Çπ110 ‚Äì ‚Çπ5000";
    return;
  }

  // Check balance
  firebase.database().ref("users/" + uid + "/balance").once("value", snap => {
    const currentBalance = snap.val() || 0;

    if (currentBalance < withdrawAmt) {
      msg.innerText = "‚ùå Insufficient balance";
      return;
    }

    // Save UPI ONLY ONCE
    firebase.database().ref("users/" + uid + "/upi").once("value", s => {
      if (!s.exists()) {
        firebase.database().ref("users/" + uid + "/upi").set(upiId);
      }

      // Create withdraw request
      firebase.database().ref("withdraws/" + uid).push({
        amount: withdrawAmt,
        upi: upiId,
        status: "pending",
        time: Date.now()
      });

      msg.innerText = "‚úÖ Withdraw request submitted (Pending)";
      amount.value = "";
    });
  });
}
</script>

</body>
</html>
